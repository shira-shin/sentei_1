<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Apple FSPM Lab - Professional Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        margin: 0;
        background-color: #0d1117;
        color: #e6edf3;
        overflow: hidden;
        font-family: sans-serif;
      }
      canvas {
        display: block;
      }
      .glass-panel {
        background: rgba(22, 27, 34, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(48, 54, 61, 0.8);
        border-radius: 12px;
      }
      .gauge-container {
        position: relative;
        width: 100px;
        height: 100px;
      }
      .gauge-svg {
        transform: rotate(-90deg);
      }
      .gauge-bg {
        fill: none;
        stroke: #30363d;
        stroke-width: 8;
      }
      .gauge-val {
        fill: none;
        stroke: #238636;
        stroke-width: 8;
        stroke-linecap: round;
        transition: stroke-dashoffset 0.5s ease;
      }
    </style>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
      }
    </script>
  </head>
  <body>
    <div id="ui-layer" class="fixed inset-0 pointer-events-none z-10 flex flex-col justify-between p-6">
      <div class="flex justify-between items-start pointer-events-auto">
        <div class="glass-panel p-4">
          <h1 class="text-xl font-bold text-lime-400">Apple FSPM Lab v2.5</h1>
          <p class="text-xs text-gray-400">機能構造植物モデル - 品種: ふじ (Fuji)</p>
        </div>
        <div class="flex gap-2">
          <button
            id="btn-step"
            class="glass-panel px-4 py-2 hover:bg-gray-800 transition pointer-events-auto text-sm font-medium"
          >
            1日進める
          </button>
          <button
            id="btn-auto"
            class="glass-panel px-4 py-2 hover:bg-gray-800 transition pointer-events-auto text-sm font-medium bg-lime-900/20 text-lime-400 border-lime-500/50"
          >
            長押し成長中
          </button>
          <button
            id="btn-reset"
            class="glass-panel px-4 py-2 hover:bg-red-900/20 text-red-400 border-red-500/50 transition pointer-events-auto text-sm"
          >
            リセット
          </button>
        </div>
      </div>

      <div class="flex flex-col items-end gap-4">
        <div class="glass-panel p-5 w-64 pointer-events-auto">
          <h2 class="text-sm font-bold mb-4 border-b border-gray-700 pb-2 uppercase tracking-widest text-gray-400">
            樹体診断パネル
          </h2>

          <div class="mb-6">
            <div class="flex justify-between text-xs mb-1">
              <span>T/Rバランス (Shoot/Root)</span>
              <span id="tr-val">1.0</span>
            </div>
            <div class="h-1.5 w-full bg-gray-800 rounded-full overflow-hidden flex">
              <div id="tr-bar-shoot" class="h-full bg-blue-500" style="width: 50%"></div>
              <div id="tr-bar-root" class="h-full bg-orange-500" style="width: 50%"></div>
            </div>
            <div class="flex justify-between text-[10px] mt-1 text-gray-500 italic">
              <span>地上部</span>
              <span>地下部</span>
            </div>
          </div>

          <div class="flex items-center gap-4 mb-4">
            <div class="gauge-container">
              <svg class="gauge-svg w-full h-full" viewBox="0 0 100 100">
                <circle class="gauge-bg" cx="50" cy="50" r="40"></circle>
                <circle
                  id="cn-gauge"
                  class="gauge-val"
                  cx="50"
                  cy="50"
                  r="40"
                  stroke-dasharray="251.2"
                  stroke-dashoffset="125.6"
                ></circle>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center text-[10px] font-bold">C/N比</div>
            </div>
            <div>
              <div class="text-[10px] text-gray-400">同化産物蓄積</div>
              <div id="nsc-val" class="text-lg font-mono text-lime-400">0.00</div>
              <div class="text-[10px] text-gray-500">units/metamer</div>
            </div>
          </div>

          <div class="text-[11px] bg-black/40 p-2 rounded border border-gray-800">
            <span class="text-blue-400 font-bold">STATUS:</span>
            <span id="status-msg">シミュレーション準備完了</span>
          </div>
        </div>

        <div class="glass-panel p-4 w-64 pointer-events-auto">
          <p class="text-[10px] text-gray-400 mb-2 leading-relaxed">
            枝をクリックして<span class="text-red-400">剪定</span>します。頂芽優勢が解除され、休眠芽が動き出す様子を観察してください。
          </p>
        </div>
      </div>
    </div>

    <script type="module">
      import * as THREE from "three";
      import { OrbitControls } from "three/addons/controls/OrbitControls.js";

      const GENOTYPE = {
        FUJI: {
          name: "ふじ",
          apical_dominance: 0.85,
          internode_length: 5.0,
          branching_angle: Math.PI / 4,
          dwarfing: 0.8,
          light_efficiency: 0.9,
        },
      };

      class Metamer {
        constructor(parent = null, order = 0) {
          this.id = Math.random().toString(36).substr(2, 9);
          this.parent = parent;
          this.children = [];
          this.order = order;

          this.length = GENOTYPE.FUJI.internode_length;
          this.diameter = 0.2;
          this.angleX = (Math.random() - 0.5) * 0.1;
          this.rotationY = parent ? parent.rotationY + 2.399 : 0;

          this.nsc = 5.0;
          this.auxin = 1.0;
          this.leafArea = 30.0;
          this.isPruned = false;
          this.age = 0;

          this.mesh = null;
          this.budMesh = null;
        }

        getTotalLeafArea() {
          let area = this.leafArea;
          for (const child of this.children) {
            area += child.getTotalLeafArea();
          }
          return area;
        }

        updateThickness() {
          const totalArea = this.getTotalLeafArea();
          this.diameter = 0.15 * Math.sqrt(totalArea);
          if (this.diameter < 0.1) this.diameter = 0.1;
        }
      }

      let scene;
      let camera;
      let renderer;
      let controls;
      let rootMetamer = null;
      let allMetamers = [];
      let isAutoGrowing = false;

      function initThree() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0d1117);

        const grid = new THREE.GridHelper(100, 20, 0x30363d, 0x161b22);
        scene.add(grid);

        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(20, 30, 50);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        const ambientLight = new THREE.AmbientLight(0x404040, 2);
        scene.add(ambientLight);

        const sunLight = new THREE.DirectionalLight(0xffffff, 1.5);
        sunLight.position.set(10, 50, 10);
        scene.add(sunLight);

        window.addEventListener("resize", () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        });

        resetSimulation();
        animate();
      }

      function resetSimulation() {
        allMetamers.forEach((metamer) => {
          if (metamer.mesh) scene.remove(metamer.mesh);
          if (metamer.budMesh) scene.remove(metamer.budMesh);
        });

        rootMetamer = new Metamer(null, 0);
        allMetamers = [rootMetamer];
        updateTreeVisualization();
        updateUI();
      }

      function simulateDay() {
        const sunIntensity = 1200;
        let totalPS = 0;

        allMetamers.forEach((metamer) => {
          const ps = (sunIntensity * 0.05 * metamer.leafArea) / (sunIntensity + 100) - 0.5;
          metamer.nsc += ps;
          totalPS += ps;
          metamer.age++;
        });

        const newNodes = [];
        allMetamers.forEach((metamer) => {
          metamer.auxin = Math.max(0.1, 1.0 - metamer.age * 0.05);

          if (metamer.children.length < 2 && metamer.nsc > 10.0) {
            const isMain = metamer.children.length === 0;
            const branchAngle = isMain ? 0.1 : GENOTYPE.FUJI.branching_angle;

            const child = new Metamer(metamer, isMain ? metamer.order : metamer.order + 1);
            child.angleX = branchAngle;

            metamer.nsc -= 8.0;
            metamer.children.push(child);
            newNodes.push(child);
          }
        });

        allMetamers.push(...newNodes);

        allMetamers.forEach((metamer) => metamer.updateThickness());

        updateTreeVisualization();
        updateUI(totalPS);
      }

      function updateTreeVisualization() {
        allMetamers.forEach((metamer) => {
          if (metamer.mesh) scene.remove(metamer.mesh);
          if (metamer.budMesh) scene.remove(metamer.budMesh);

          const geo = new THREE.CylinderGeometry(
            metamer.diameter * 0.8,
            metamer.parent ? metamer.parent.diameter : metamer.diameter,
            metamer.length,
            8,
          );
          geo.translate(0, metamer.length / 2, 0);

          const mat = new THREE.MeshStandardMaterial({
            color: 0x4a3728,
            roughness: 0.9,
            metalness: 0.1,
          });

          const mesh = new THREE.Mesh(geo, mat);
          metamer.mesh = mesh;

          if (metamer.parent) {
            mesh.position.set(0, metamer.parent.length, 0);
            metamer.parent.mesh.add(mesh);
            mesh.rotation.x = metamer.angleX;
            mesh.rotation.y = metamer.rotationY;
          } else {
            scene.add(mesh);
            mesh.position.set(0, 0, 0);
          }

          if (metamer.children.length === 0) {
            const budGeo = new THREE.SphereGeometry(metamer.diameter * 1.5);
            const budMat = new THREE.MeshStandardMaterial({
              color: 0xafff00,
              emissive: 0xafff00,
              emissiveIntensity: 2,
            });
            const bud = new THREE.Mesh(budGeo, budMat);
            bud.position.set(0, metamer.length, 0);
            mesh.add(bud);
            metamer.budMesh = bud;
          }
        });
      }

      function updateUI(dailyPS = 0) {
        document.getElementById("tr-val").innerText = (allMetamers.length * 0.2).toFixed(2);
        document.getElementById("nsc-val").innerText = rootMetamer.nsc.toFixed(2);

        const offset = 251.2 - (Math.min(rootMetamer.nsc, 20) / 20) * 251.2;
        document.getElementById("cn-gauge").style.strokeDashoffset = offset;

        const msg = dailyPS > 0 ? "光合成によりエネルギー蓄積中..." : "休眠中";
        document.getElementById("status-msg").innerText = msg;
      }

      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        if (isAutoGrowing) simulateDay();
        renderer.render(scene, camera);
      }

      document.getElementById("btn-step").addEventListener("click", simulateDay);
      document.getElementById("btn-auto").addEventListener("mousedown", () => (isAutoGrowing = true));
      document.getElementById("btn-auto").addEventListener("mouseup", () => (isAutoGrowing = false));
      document.getElementById("btn-reset").addEventListener("click", resetSimulation);

      window.onload = initThree;
    </script>
  </body>
</html>
